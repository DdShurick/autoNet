#!/bin/sh
#wi-fi up. DdShurick 29.07.18

if [ $(id -u) != 0 ]; then loginroot $0; exit 0; fi

. /usr/lib64/upNet/libupNet
WPADIR="/etc/net/wpa_profiles/"

ifdown () {
	[ $(pidof wpa_supplicant) ] && kill $(pidof wpa_supplicant)
	ifconfig $IFACE down
	exit 1
}

IFACE=$(basename $(dirname /sys/class/net/*/phy80211)) 2>/dev/null
if [ "$IFACE" ]; then
	if [ "$(echo $IFACE | wc -w)" -gt 1 ]; then
		export Iface="<window icon-name=\"network\" title=\"Wi-Fi\" resizable=\"false\"><vbox>
		<text><label>Выберите интерфейс</label></text>
		<tree>
		 <variable>IFACE</variable>
		 $(echo "$IFACE" | sed 's/^/<item>/;s/$/<\/item>/')
		</tree>
		<button><label>Подключить</label></button>
		</vbox></window>"
		eval $(gtkdialog -c --display=:0 --program "Iface")
		[ "$EXIT" = "Cancel" -o  "$EXIT" = "abort" ] && exit 1
	fi
else
	export Iface="<window icon-name=\"network\" title=\"Wi-Fi\" resizable=\"false\"><vbox>
	<text><label>Нет wi-fi интерфейсов</label></text>
	<button><label>Выйти</label></button>
	</vbox></window>"
	eval $(gtkdialog -c --program "Iface")
	exit 1
fi
#[ $(pidof dhcpcd) ] && dhcpcd -k $IFACE
[ $(pidof wpa_supplicant) ] && kill $(pidof wpa_supplicant)
/sbin/ifconfig $IFACE up
sleep 2
/usr/bin/iwlist $IFACE scan | egrep 'Address:|Channel:|Quality|Encryption key:|ESSID:' | tee /tmp/iwlist
export Window="<window title=\"Wi-Fi\"><vbox>
  <text><label>Найдены сети Wi-Fi</label></text>
  <list>
   <variable>MYESSID</variable>
   $(awk -F \: '/ESSID/ {print "<item>"$2"</item>"}' /tmp/iwlist)
  </list>
  <button><label>Подключить</label></button>
 </vbox></window>"
eval $(gtkdialog -c --program "Window")

[ "$EXIT" = "Cancel" -o  "$EXIT" = "abort" -o "$MYESSID" = "" ] && ifdown
[  "$EXIT" = "Подключить"  ]|| ifdown

 

KEY=$(grep -B 1 $MYESSID /tmp/iwlist | awk '/Encryption/ {print $2}')
if [ "$KEY" = "key:on" ]; then
	export Passw="<window icon-name=\"network\" title=\"Wi-Fi\" resizable=\"false\"><vbox>
  <text><label>Введите пароль для $MYESSID</label></text>
  <entry>
   <visible>password</visible>
   <variable>MYPASSWD</variable>
  </entry>
  <button><label>Подключить</label></button>
</vbox></window>"
	eval $(gtkdialog -c --program "Passw") 
	[ "$EXIT" = "Cancel" -o  "$EXIT" = "abort" ] && exit 1
	[ "$MYPASSWD" ] || exit 1
	[  "$EXIT" = "Подключить"  ] || exit 1
	/usr/sbin/wpa_passphrase "$MYESSID" "$MYPASSWD" | /bin/grep -v '#psk' | tee /tmp/wpa.conf
	if /usr/sbin/wpa_supplicant -B -D nl80211 -i $IFACE -c /tmp/wpa.conf; then 2>&1 | tee -a /var/log/${IFACE}.log
		dhcpc #$(/sbin/udhcpc -i $IFACE -n 2>/dev/null) #-->libupNet
#		/sbin/udhcpc -n -i $IFACE | /usr/bin/tee -a /var/log/$IFACE.log
		
		if [ "$?" = 0 ]; then
			export Addr="<window icon-name=\"network\" title=\"Wi-Fi\" resizable=\"false\"><vbox>
  <frame Сеть $MYESSID Ok>
  <text><label>Сохранить ${MYESSID}?</label></text>
  <button><height>100</height>
  	<input file>/usr/share/pixmaps/wireless_on.svg</input>
  	<action function=\"exit\">Сохранить</action>
  </button>
</frame></vbox></window>"
			eval $(gtkdialog -c --display=:0 --program "Addr") 
			[ "$EXIT" = "Cancel" -o  "$EXIT" = "abort" ] && exit
			[ "$EXIT" = "Сохранить"  ] || exit
			MYADDR=$(/usr/bin/grep -B 5 "$MYESSID" /tmp/iwlist | /usr/bin/awk '/Address/ {print $5}')
			/bin/cp /tmp/wpa.conf /etc/net/wpa_profiles/${MYADDR}.wpa.conf
		else
			tunstatic $IFACE
		fi
	else
		ifdown
	fi
elif [ "$KEY" = "key:off" ]; then
	/usr/bin/iwconfig $IFACE essid "$MYESSID" key off
	dhcpc #$(/sbin/udhcpc -i $IFACE -n 2>/dev/null)
#	/sbin/udhcpc -n -i $IFACE | /usr/bin/tee -a /var/log/$IFACE.log
fi
