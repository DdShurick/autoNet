#!/bin/sh
#internet up. DdShurick 28.06.2016 version 004
[ $(/usr/bin/id -u) = 0 ] || exec loginroot $0

msg () {
	xpupsay "$1 отключен."
}

up_func () {
 case $1 in
	modem)
		sed -i "s/modem off/modem on/" /etc/network-wizard/network/interfaces.lck
		/bin/ls -1 /dev/ttyUSB? | while read M
		do
			/lib/udev/up3Gmodem $(basename $M)
		done
	;;
	*)
		MCADDR=$(cat /sys/class/net/$1/address)
		sed -i "s/$MCADDR off/$MCADDR on/"  
		/lib/udev/upNet $1
	;;
 esac
echo $1 up
}

down_func () {
[ -f /var/run/dhcpcd-${1}.pid ] && /usr/sbin/dhcpcd -k $1
[ $(/bin/pidof wpa_supplicant) ] && /bin/kill $(/bin/pidof wpa_supplicant)
[ $(/bin/pidof wvdial) ] && /bin/kill $(/bin/pidof wvdial)
[ $(/bin/pidof pppd) ] && /bin/kill $(/bin/pidof pppd)
[ "$(cat /sys/class/net/$1/operstate)" = down ] || ifconfig $1 down
if [ -h /sys/class/net/$1 ]; then
	MCADDR=$(cat /sys/class/net/$1/address)
	sed -i "s/$MCADDR on/$MCADDR off/" /etc/network-wizard/network/interfaces.lck
fi
sed -i "s/modem on/modem off/" /etc/network-wizard/network/interfaces.lck 
echo "$1 down"
}

all_off () {
ls -1 /sys/class/net | grep -v lo | while read IFACE
do
	down_func $IFACE
done 
}

echo "export Window='<frame Обнаружены интерфейсы><hbox>" > /tmp/connect
#модем
if [ -d /sys/bus/usb-serial/devices/ttyUSB0 -o -d /sys/bus/usb-serial/devices/ttyACM0 ]; then
	if [ "$(pidof wvdial)" ]; then
	 ST=подключен
	 ACT="msg"
	else
	 ST=отключен
	 ACT=up_func
	fi
echo "<frame Модем $ST>
 <button>
	<input file>/usr/share/pixmaps/3g.png</input>
	<action function=\"exit\">$ACT modem</action>
 </button>
</frame>" >> /tmp/connect
fi
for IFACE in $(ls /sys/class/net)
do
 case $IFACE in
#провод 
  e*) IMG=inet.png ;;
  u*|w*|r*) IMG=wifi7.png ;;
  *) continue ;;
 esac
 
if [ "$(cat /sys/class/net/$IFACE/operstate)" = down ]; then
 ACT="up_func"
 ST=отключен
else
 ACT="msg"
 ST=подключен
fi

echo "<vbox>
<frame $IFACE $ST>
 <button>
	<input file>/usr/share/pixmaps/$IMG</input>
	<action function=\"exit\">$ACT $IFACE</action>
 </button></frame>
</vbox>" >> /tmp/connect
done

echo "</hbox></frame>'" >> /tmp/connect
. /tmp/connect
eval $(/usr/sbin/gtkdialog -c --display=:0 --program "Window")

if [ "$EXIT" = "Cancel" -o  "$EXIT" = "abort" ]; then
 [ "$UP" = up ] || /sbin/ifconfig $IFACE down
 exit
fi
all_off
$EXIT
exit
